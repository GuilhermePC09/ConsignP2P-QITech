{% load static %}

<style>
/* Topbar-only enhancements */
.site-header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border);transition:var(--transition)}
.site-header.scrolled{box-shadow:var(--shadow-2)}
.site-header .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;max-width:1100px;margin:0 auto}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none}
.brand .logo{font-weight:800;font-size:20px;color:var(--brand-600)}
.nav{display:flex;align-items:center;gap:6px}
.nav-link{
  position:relative;display:inline-block;padding:10px 12px;
  color:var(--ink-800);text-decoration:none;font-weight:600;border-radius:10px
}
.nav-link:hover{background:color-mix(in oklab, var(--muted) 70%, transparent)}
.nav-link:after{
  content:"";position:absolute;left:12px;right:12px;bottom:6px;height:2px;border-radius:2px;
  background:linear-gradient(90deg,var(--brand-700),var(--brand-600));
  transform:scaleX(0);transform-origin:left;transition:transform .18s ease
}
.nav-link:hover:after{transform:scaleX(1)}
.nav-link[aria-current="page"]{color:var(--brand-700)}
.nav-link[aria-current="page"]::after{transform:scaleX(1)}

/* Disabled/unimplemented nav items */
.nav-link.disabled,
.dropdown a.disabled{
  opacity:0.5;
  cursor:not-allowed;
  pointer-events:none;
}
.nav-link.disabled:hover,
.dropdown a.disabled:hover{
  background:none;
}

/* Dropdown (hover) */
.nav-item{position:relative}
.dropdown{
  position:absolute;top:100%;left:0;margin-top:6px;min-width:220px;
  background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-3);
  padding:8px;opacity:0;transform:translateY(6px);pointer-events:none;
  transition:opacity .25s ease, transform .25s ease;visibility:hidden
}
.nav-item:hover .dropdown,
.nav-item.dropdown-open .dropdown{
  opacity:1;transform:translateY(0);pointer-events:auto;visibility:visible
}
.dropdown a{display:flex;align-items:center;padding:10px 12px;border-radius:10px;color:var(--ink-800);text-decoration:none;font-weight:500}
.dropdown a:hover{background:color-mix(in oklab, var(--muted) 75%, transparent)}
.dropdown a[style*="color:var(--red-600)"]:hover{background:color-mix(in oklab, var(--red-50) 80%, transparent)}

/* Right side */
.header-tools{display:flex;align-items:center;gap:12px}

/* Mobile */
.nav-toggle{display:none;appearance:none;border:0;background:transparent;padding:8px;border-radius:8px}
.nav-toggle:focus-visible{outline:none;box-shadow:0 0 0 3px var(--brand-100)}
.nav-panel{
  display:none;position:fixed;inset:56px 0 auto 0;background:#fff;border-bottom:1px solid var(--border);
  box-shadow:var(--shadow-2);padding:10px 16px
}
.nav-panel a{display:block;padding:12px 8px;color:var(--ink-800);text-decoration:none;font-weight:600;border-radius:10px}
.nav-panel a:hover{background:color-mix(in oklab, var(--muted) 70%, transparent)}
.nav-panel a.disabled{opacity:0.5;cursor:not-allowed;pointer-events:none}
.nav-panel a.disabled:hover{background:none}
@media (max-width: 900px){
  .nav{display:none}
  .nav-toggle{display:inline-flex}
}
</style>

<header class="site-header" id="siteHeader">
  <div class="bar">
    <a href="{% url 'frontend:home' %}" class="brand">
      <div class="logo">QInvest</div>
    </a>

    <!-- Nav principal -->
    <nav class="nav" aria-label="Primária">
      <div class="nav-item">
        <a class="nav-link" {% if current_page == 'home' %}aria-current="page"{% endif %} href="{% url 'frontend:home' %}">Início</a>
      </div>
      
      {% if user.is_authenticated %}
        {% if is_investor or user_type == 'both' %}
        <div class="nav-item">
          <a class="nav-link" {% if current_page == 'marketplace' %}aria-current="page"{% endif %} href="{% url 'frontend:marketplace' %}">Investir</a>
        </div>
        <div class="nav-item">
          <a class="nav-link disabled" href="#">Minhas Posições</a>
          <div class="dropdown" role="menu" aria-label="Minhas Posições">
            <a href="#" class="disabled">Visão geral</a>
            <a href="#" class="disabled">Proventos</a>
            <a href="#" class="disabled">Risco / Alocação</a>
          </div>
        </div>
        <div class="nav-item">
          <a class="nav-link disabled" href="#">Mercado Secundário</a>
          <div class="dropdown" role="menu" aria-label="Mercado Secundário">
            <a href="#" class="disabled">Ofertas abertas</a>
            <a href="#" class="disabled">Meus anúncios</a>
          </div>
        </div>
        {% endif %}
        
        {% if is_borrower or user_type == 'both' %}
        <div class="nav-item">
          <a class="nav-link" {% if current_page == 'loan_simulation' %}aria-current="page"{% endif %} href="{% url 'frontend:loan_simulation' %}">Simular Empréstimo</a>
        </div>
        {% endif %}
      {% else %}
        <div class="nav-item">
          <a class="nav-link" {% if current_page == 'register' %}aria-current="page"{% endif %} href="{% url 'frontend:register_choice' %}">Cadastro</a>
        </div>
        <div class="nav-item">
          <a class="nav-link" {% if current_page == 'login' %}aria-current="page"{% endif %} href="{% url 'frontend:login' %}">Login</a>
        </div>
      {% endif %}
    </nav>

    <!-- Ferramentas à direita -->
    <div class="header-tools">
      {% if user.is_authenticated %}
        <!-- Profile dropdown -->
        <div class="nav-item">
          <a href="#" class="nav-link" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--ink-800);font-weight:700">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            {% if user.first_name %}{{ user.first_name }}{% else %}Perfil{% endif %}
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6,9 12,15 18,9"/>
            </svg>
          </a>
          <div class="dropdown" role="menu" aria-label="Menu do perfil">
            <a href="{% url 'frontend:welcome' %}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              Minha conta
            </a>
            {% if is_borrower or user_type == 'both' %}
            <a href="{% url 'frontend:document_verification' %}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14,2 14,8 20,8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              Documentos
            </a>
            {% endif %}
            <div style="height:1px;background:var(--border);margin:6px 0"></div>
            <a href="{% url 'frontend:logout' %}" style="color:var(--red-600)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Sair
            </a>
          </div>
        </div>
      {% else %}
        <a href="{% url 'frontend:login' %}" class="nav-link">Entrar</a>
      {% endif %}
      
      <button id="navToggle" class="nav-toggle" aria-label="Abrir menu" aria-expanded="false">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Painel mobile -->
  <div id="navPanel" class="nav-panel" aria-hidden="true">
    <a href="{% url 'frontend:home' %}" {% if current_page == 'home' %}aria-current="page"{% endif %}>Início</a>
    
    {% if user.is_authenticated %}
      <a href="{% url 'frontend:welcome' %}" {% if current_page == 'welcome' %}aria-current="page"{% endif %}>Dashboard</a>
      
      {% if is_borrower or user_type == 'both' %}
        <a href="{% url 'frontend:loan_simulation' %}" {% if current_page == 'loan_simulation' %}aria-current="page"{% endif %}>Simular Empréstimo</a>
      {% endif %}
      
      {% if is_investor or user_type == 'both' %}
        <a href="{% url 'frontend:marketplace' %}" {% if current_page == 'marketplace' %}aria-current="page"{% endif %}>Investir</a>
        <a href="#" class="disabled">Minhas Posições</a>
        <a href="#" class="disabled">Mercado Secundário</a>
      {% endif %}
      
      <div style="height:8px"></div>
      <a href="{% url 'frontend:welcome' %}">Minha conta</a>
      <a href="{% url 'frontend:logout' %}" style="color:var(--red-600)">Sair</a>
    {% else %}
      <a href="{% url 'frontend:register_choice' %}" {% if current_page == 'register' %}aria-current="page"{% endif %}>Cadastro</a>
      <a href="{% url 'frontend:login' %}" {% if current_page == 'login' %}aria-current="page"{% endif %}>Login</a>
    {% endif %}
  </div>
</header>

<script>
// Mobile navigation toggle
document.addEventListener('DOMContentLoaded', function() {
  const navToggle = document.getElementById('navToggle');
  const navPanel = document.getElementById('navPanel');
  
  if (navToggle && navPanel) {
    navToggle.addEventListener('click', function() {
      const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
      navToggle.setAttribute('aria-expanded', !isExpanded);
      navPanel.setAttribute('aria-hidden', isExpanded);
      navPanel.style.display = isExpanded ? 'none' : 'block';
    });
  }
  
  // Header scroll effect
  const header = document.getElementById('siteHeader');
  if (header) {
    window.addEventListener('scroll', function() {
      if (window.scrollY > 0) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });
  }
  
  // Enhanced dropdown interactions
  const dropdownItems = document.querySelectorAll('.nav-item');
  let hoverTimeout;
  
  dropdownItems.forEach(item => {
    const dropdown = item.querySelector('.dropdown');
    if (!dropdown) return;
    
    // Mouse enter with delay
    item.addEventListener('mouseenter', function() {
      clearTimeout(hoverTimeout);
      hoverTimeout = setTimeout(() => {
        item.classList.add('dropdown-open');
      }, 100); // Small delay to prevent accidental opens
    });
    
    // Mouse leave with delay
    item.addEventListener('mouseleave', function() {
      clearTimeout(hoverTimeout);
      hoverTimeout = setTimeout(() => {
        item.classList.remove('dropdown-open');
      }, 150); // Slightly longer delay to prevent accidental closes
    });
    
    // Click to toggle on mobile/touch devices
    const trigger = item.querySelector('a[href="#"]');
    if (trigger) {
      trigger.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Close other dropdowns
        dropdownItems.forEach(otherItem => {
          if (otherItem !== item) {
            otherItem.classList.remove('dropdown-open');
          }
        });
        
        // Toggle current dropdown
        item.classList.toggle('dropdown-open');
      });
    }
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.nav-item')) {
      dropdownItems.forEach(item => {
        item.classList.remove('dropdown-open');
      });
    }
  });
});
</script>