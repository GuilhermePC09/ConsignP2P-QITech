{% extends 'frontend/base.html' %}

{% block title %}QInvest ‚Äî Registrar Oferta no Marketplace (Etapa 6 de 6){% endblock %}

{% block content %}
<div class="wrapper">
    <div class="card" style="margin-bottom:16px">
        <div class="body">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
                <div style="display:flex; align-items:center; gap:8px; color:#059669; font-weight:700">
                    <span style="width:10px;height:10px;background:var(--success);border-radius:999px"></span> 
                    Valor Liberado
                </div>
                <span class="status-badge">Aprovado</span>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-title">Valor Aprovado</div>
                    <div class="stat-value">R$ {{ loan_data.amount|floatformat:2 }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Taxa Mensal</div>
                    <div class="stat-value">{{ loan_data.monthly_rate|floatformat:1 }}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Valor da Parcela</div>
                    <div class="stat-value">R$ {{ loan_data.monthly_payment|floatformat:2 }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Parcelas</div>
                    <div class="stat-value">{{ loan_data.term }}x</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <header><h2>Registrar Oferta no Marketplace</h2></header>
        <div class="body" style="padding:0">
            <table class="table">
                <tbody>
                    <tr><th>Valor Solicitado</th><td class="value">R$ {{ loan_data.amount|floatformat:2 }}</td></tr>
                    <tr><th>Taxa de Juros</th><td class="value">{{ loan_data.monthly_rate|floatformat:1 }}% a.m.</td></tr>
                    <tr><th>N√∫mero de Parcelas</th><td class="value">{{ loan_data.term }} parcelas</td></tr>
                    <tr><th>Valor da Parcela</th><td class="value highlight">R$ {{ loan_data.monthly_payment|floatformat:2 }}</td></tr>
                    <tr><th>Total a Pagar</th><td class="value">R$ {{ loan_data.total_payment|floatformat:2 }}</td></tr>
                    <tr><th>Total de Juros</th><td class="value danger">R$ {{ loan_data.total_interest|floatformat:2 }}</td></tr>
                </tbody>
            </table>
            
            <div style="margin: 16px; padding: 12px; background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; font-size: 14px; color: #0C4A6E;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <strong>Como funciona:</strong>
                </div>
                <p style="margin: 0;">Ao registrar sua oferta no marketplace, investidores poder√£o visualiz√°-la e decidir se querem financiar seu empr√©stimo. Voc√™ receber√° notifica√ß√µes quando houver interesse e poder√° acompanhar o progresso na sua dashboard.</p>
            </div>
            
            <div class="form-actions">
                                <a class="btn btn-success" href="#" id="contractBtn" data-offer-id="{{ loan_data.offer_id }}">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px">
                                        <rect x="3" y="7" width="18" height="13" rx="2" ry="2"/>
                                        <path d="M16 3v4M8 3v4"/>
                                        <path d="M3 7h18"/>
                                    </svg>
                                    Registrar no Marketplace
                                </a>
                                                                <a class="btn btn-outline" href="{% url 'download_offer_proposal' loan_data.offer_id %}" download>
                                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px">
                                                                        <path d="M12 5v14"/>
                                                                        <path d="M19 12l-7 7-7-7"/>
                                                                    </svg>
                                                                    Baixar Proposta
                                                                </a>
            </div>
        </div>
    </div>

    <div class="form-actions">
        {% if navigation.back_url %}
            <a class="btn btn-secondary" href="{% url navigation.back_url %}">‚Üê Voltar</a>
        {% else %}
            <a class="btn btn-secondary" href="{% url 'frontend:document_verification' %}">‚Üê Voltar</a>
        {% endif %}
    </div>
</div>

<script>
// Get CSRF token for API calls
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Robust back navigation function
function goBack() {
    // Use navigation context if available
    {% if navigation.back_url %}
        window.location.href = "{% url navigation.back_url %}";
    {% else %}
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = "{% url 'frontend:document_verification' %}";
        }
    {% endif %}
}

document.addEventListener('DOMContentLoaded', function() {
    const contractBtn = document.getElementById('contractBtn');
    
    // Handle contract loan button click
    if (contractBtn) {
        contractBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const offerId = this.getAttribute('data-offer-id');
            const confirmed = confirm('Tem certeza que deseja registrar esta oferta no marketplace para investidores?');
            if (confirmed) {
                this.innerHTML = `<svg width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'><rect x='3' y='7' width='18' height='13' rx='2' ry='2'/><path d='M16 3v4'/><path d='M8 3v4'/><path d='M3 7h18'/></svg> Registrar no Marketplace`;
                this.style.pointerEvents = 'none';
                const apiUrl = `{% url 'frontend:api_register_offer' '0000' %}`.replace('0000', offerId);
                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.detail || 'Erro ao processar contrata√ß√£o');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    alert('Oferta registrada com sucesso no marketplace! ' + (data.message || 'Mock registrada.'));
                    window.location.href = "http://127.0.0.1:8000/welcome/";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erro ao registrar oferta: ' + error.message);
                    this.innerHTML = 'üè™ &nbsp;Registrar no Marketplace';
                    this.style.pointerEvents = 'auto';
                });
            }
        });
    }
    
    // Handle download button if offer ID is missing
    const downloadBtn = document.querySelector('a[href="#"]');
    if (downloadBtn && downloadBtn.textContent.includes('Baixar Proposta')) {
        downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            alert('Simula√ß√£o n√£o encontrada. Por favor, refa√ßa a simula√ß√£o para baixar a proposta.');
        });
    }
});
</script>
{% endblock %}