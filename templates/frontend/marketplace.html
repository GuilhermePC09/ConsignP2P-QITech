{% extends 'frontend/base.html' %}
{% load marketplace_filters %}

{% block title %}QInvest — Marketplace de Ofertas{% endblock %}

{% block content %}
<section class="wrapper" style="max-width:1100px; padding-bottom:32px;">
    <div style="display:flex;align-items:end;justify-content:space-between;gap:12px">
        <div>
            <h1 style="margin-top:24px;margin-bottom:6px">Marketplace de Ofertas</h1>
            <p class="lead" style="text-align:left;margin-left:0">Explore oportunidades de investimento em crédito consignado P2P</p>
        </div>
        <div style="text-align:right">
            <div style="font-size:14px;color:#64748B;margin-bottom:4px">Ofertas disponíveis</div>
            <div style="font-weight:800;font-size:24px;color:var(--brand-600)">{{ offers.paginator.count }}</div>
        </div>
    </div>

    <!-- Filters Card -->
    <div id="filters" class="card card-spaced" style="margin-top:16px">
        <header style="display:flex;align-items:center;gap:10px;justify-content:space-between">
            <div style="display:flex;align-items:center;gap:10px"><span style="font-weight:700">Filtros</span></div>
        </header>
        <div class="body">
            <form method="GET" id="filter-form">
                <!-- Row 1: Value Range -->
                <div class="row">
                    <div class="field">
                        <label class="label" for="vmin">Valor Mínimo</label>
                        <div class="input"><span class="prefix">R$</span><input id="vmin" name="valor_min" placeholder="500,00" value="{{ request.GET.valor_min }}"/></div>
                    </div>
                    <div class="field">
                        <label class="label" for="vmax">Valor Máximo</label>
                        <div class="input"><span class="prefix">R$</span><input id="vmax" name="valor_max" placeholder="20.000,00" value="{{ request.GET.valor_max }}"/></div>
                    </div>
                </div>

                <!-- Row 2: Term Range -->
                <div class="row">
                    <div class="field">
                        <label class="label" for="pmin">Prazo Mínimo (meses)</label>
                        <div class="input">
                            <input type="number" id="pmin" name="prazo_min" placeholder="1" min="1" max="96" value="{{ request.GET.prazo_min }}"/>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="pmax">Prazo Máximo (meses)</label>
                        <div class="input">
                            <input type="number" id="pmax" name="prazo_max" placeholder="96" min="1" max="96" value="{{ request.GET.prazo_max }}"/>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Rate Range and Sort -->
                <div class="row">
                    <div class="field">
                        <label class="label" for="tmin">Taxa Mínima (%)</label>
                        <div class="input"><input id="tmin" name="taxa_min" placeholder="1,5" value="{{ request.GET.taxa_min }}"/></div>
                    </div>
                    <div class="field">
                        <label class="label" for="tmax">Taxa Máxima (%)</label>
                        <div class="input"><input id="tmax" name="taxa_max" placeholder="3,5" value="{{ request.GET.taxa_max }}"/></div>
                    </div>
                </div>

                <!-- Row 4: Risk and Sort -->
                <div class="row">
                    <div class="field">
                        <label class="label">Nível de Risco</label>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                            <button type="button" class="btn btn-outline risk-filter" data-risk="baixo" 
                                    style="border-color:#10B981;color:#059669;background:{% if 'baixo' in request.GET.risco %}#E6F9ED{% else %}transparent{% endif %}">Baixo</button>
                            <button type="button" class="btn btn-outline risk-filter" data-risk="medio"
                                    style="border-color:#F59E0B;color:#B45309;background:{% if 'medio' in request.GET.risco %}#FEF3C7{% else %}transparent{% endif %}">Médio</button>
                            <button type="button" class="btn btn-outline risk-filter" data-risk="alto"
                                    style="border-color:#DC2626;color:#B91C1C;background:{% if 'alto' in request.GET.risco %}#FEE2E2{% else %}transparent{% endif %}">Alto</button>
                        </div>
                        <input type="hidden" name="risco" id="risco-input" value="{{ request.GET.risco }}">
                    </div>
                    <div class="field">
                        <label class="label" for="sort">Ordenar por</label>
                        <div class="input">
                            <select id="sort" name="ordenar">
                                <option value="taxa_desc" {% if request.GET.ordenar == "taxa_desc" %}selected{% endif %}>Maior taxa</option>
                                <option value="taxa_asc" {% if request.GET.ordenar == "taxa_asc" %}selected{% endif %}>Menor taxa</option>
                                <option value="recente" {% if request.GET.ordenar == "recente" %}selected{% endif %}>Mais recente</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions" style="padding-top:16px; display:flex; justify-content:flex-end; gap:10px;">
                    <a class="btn btn-secondary" href="{% url 'frontend:marketplace' %}">Limpar Filtros</a>
                    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Offers Grid -->
    <div class="marketplace-grid">
        {% for offer in offers %}
        <div class="card">
            <div class="body">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                    <div style="font-size:14px;color:#64748B;font-weight:600">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:text-bottom;margin-right:4px">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        {{ offer.borrower.name }}
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:start">
                    <div style="font-weight:800;font-size:22px">R$ {{ offer.amount|format_currency }}</div>
                    <div style="color:#16A34A;font-weight:700;font-size:18px">{{ offer.rate|floatformat:1 }}%</div>
                </div>
                <div style="margin-top:10px;font-size:14px;line-height:1.8">
                    <div><b>CET Anual:</b> {{ offer.rate|calculate_cet }}%</div>
                    <div><b>Prazo:</b> {{ offer.term_months }} meses</div>
                    <div><b>Risco:</b> 
                        <span class="status-badge" style="{{ offer.rate|risk_color }}">
                            {{ offer.rate|risk_level }}
                        </span>
                    </div>
                    <div><b>Válido até:</b> {% if offer.valid_until %}{{ offer.valid_until|date:"d/m/Y" }}{% else %}Sem prazo{% endif %}</div>
                    <div><b>Status:</b> 
                        <span class="status-badge" style="
                            {% if offer.status == 'open' %}background:#E6F9ED;color:#059669{% endif %}
                            {% if offer.status == 'draft' %}background:#DBEAFE;color:#1D4ED8{% endif %}
                            {% if offer.status == 'closed' or offer.status == 'funded' %}background:#F1F5F9;color:#6B7280{% endif %}
                        ">
                            {% if offer.status == 'open' %}Aberta{% endif %}
                            {% if offer.status == 'draft' %}Proposta{% endif %}
                            {% if offer.status == 'funded' %}Financiado{% endif %}
                            {% if offer.status == 'closed' %}Encerrada{% endif %}
                        </span>
                    </div>
                </div>
                <div class="form-actions" style="padding:14px 0 0">
                    {% if offer.status == 'closed' or offer.status == 'funded' %}
                        <a class="btn btn-secondary" href="#" style="pointer-events:none;opacity:.55">Oferta Encerrada</a>
                    {% else %}
                        <a class="btn btn-primary" href="{% url 'frontend:offer_details' offer.offer_id %}">Detalhes da Oferta</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="card" style="grid-column: 1 / -1; text-align: center;">
            <div class="body">
                <p>Nenhuma oferta encontrada com os filtros aplicados.</p>
                <a class="btn btn-secondary" href="{% url 'frontend:marketplace' %}">Ver todas as ofertas</a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if offers.has_other_pages %}
    <div class="card card-spaced" style="margin-bottom:var(--space-lg)">
        <div class="body" style="padding:var(--space-md)">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px">
                {% if offers.has_previous %}
                    <a href="?page={{ offers.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-secondary">← Anterior</a>
                {% else %}
                    <span class="btn btn-secondary" style="opacity:0.5;cursor:not-allowed">← Anterior</span>
                {% endif %}
                
                <div style="display:flex;align-items:center;gap:12px">
                    <div style="color:#64748B;font-size:14px">
                        Mostrando {{ offers.start_index }}–{{ offers.end_index }} de {{ offers.paginator.count }} ofertas
                    </div>
                    
                    <!-- Page numbers -->
                    <div style="display:flex;align-items:center;gap:4px">
                        {% for num in offers.paginator.page_range %}
                            {% if num == offers.number %}
                                <span class="btn btn-primary" style="padding:8px 12px;font-size:14px">{{ num }}</span>
                            {% elif num > offers.number|add:'-3' and num < offers.number|add:'3' %}
                                <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                   class="btn btn-secondary" style="padding:8px 12px;font-size:14px">{{ num }}</a>
                            {% elif num == 1 or num == offers.paginator.num_pages %}
                                <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                   class="btn btn-secondary" style="padding:8px 12px;font-size:14px">{{ num }}</a>
                            {% elif num == 2 or num == offers.paginator.num_pages|add:'-1' %}
                                <span style="color:#64748B;padding:8px 4px">...</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                {% if offers.has_next %}
                    <a href="?page={{ offers.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-secondary">Próxima →</a>
                {% else %}
                    <span class="btn btn-secondary" style="opacity:0.5;cursor:not-allowed">Próxima →</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Risk filter handling
    const riskFilters = document.querySelectorAll('.risk-filter');
    const riskInput = document.getElementById('risco-input');
    let selectedRisks = riskInput.value ? riskInput.value.split(',') : [];

    riskFilters.forEach(button => {
        button.addEventListener('click', function() {
            const risk = this.dataset.risk;
            
            if (selectedRisks.includes(risk)) {
                selectedRisks = selectedRisks.filter(r => r !== risk);
                this.style.background = 'transparent';
            } else {
                selectedRisks.push(risk);
                if (risk === 'baixo') this.style.background = '#E6F9ED';
                if (risk === 'medio') this.style.background = '#FEF3C7';
                if (risk === 'alto') this.style.background = '#FEE2E2';
            }
            
            riskInput.value = selectedRisks.join(',');
        });
    });

    // Currency formatting for filter inputs
    ['vmin', 'vmax'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value) {
                    e.target.value = parseInt(value).toLocaleString('pt-BR');
                }
            });
        }
    });
});
</script>
</section>
{% endblock %}